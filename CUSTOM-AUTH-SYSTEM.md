# Custom Authentication System

This document describes the custom JWT-based authentication system that replaces NextAuth.

## Overview

The custom authentication system provides:
- User registration and login
- JWT token generation and verification
- Secure password hashing
- Session management

## Environment Variables

The following environment variables are required:

```env
JWT_SECRET=your-super-secret-jwt-key-here
JWT_EXPIRATION=7d
```

If JWT_SECRET is not set, the system will fall back to NEXTAUTH_SECRET.

## API Endpoints

### POST /api/auth/signup
Register a new user.

**Request Body:**
```json
{
  "username": "string",
  "email": "string",
  "password": "string"
}
```

**Response:**
```json
{
  "success": true,
  "user": {
    "id": "ObjectId",
    "username": "string",
    "email": "string"
  },
  "token": "JWT token"
}
```

### POST /api/auth/login
Login an existing user.

**Request Body:**
```json
{
  "email": "string",
  "password": "string"
}
```

**Response:**
```json
{
  "success": true,
  "user": {
    "id": "ObjectId",
    "username": "string",
    "email": "string"
  },
  "token": "JWT token"
}
```

### GET /api/auth/verify
Verify a JWT token.

**Headers:**
```
Authorization: Bearer <token>
```

**Response:**
```json
{
  "user": {
    "id": "ObjectId",
    "username": "string",
    "email": "string"
  }
}
```

## Usage in Frontend

### Auth Context
The existing AuthContext can be used without changes:

```typescript
import { useAuth } from '@/contexts/auth-context';

const { user, login, signup, logout, isLoading, error } = useAuth();
```

### Making Authenticated Requests
Include the token in the Authorization header:

```typescript
const token = localStorage.getItem('auth-token');

fetch('/api/protected-endpoint', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

## Security Features

1. **Password Hashing**: Uses bcrypt with 12 salt rounds
2. **JWT Tokens**: Securely signed with HS256 algorithm
3. **HTTP-only Cookies**: Tokens stored securely in cookies
4. **Token Expiration**: Configurable expiration time
5. **Issuer/Audience Validation**: Tokens validated with issuer and audience claims

## Migration from NextAuth

To migrate from NextAuth:

1. Update environment variables in `.env.local`

2. Test the new authentication flow

## Troubleshooting

### Common Issues

1. **"Invalid or expired token"**
   - Ensure JWT_SECRET is set correctly
   - Check token expiration settings
   - Verify the token was generated by the same system

2. **"User not found"**
   - Verify the user exists in the database
   - Check the user ID in the token payload

3. **"Invalid email or password"**
   - Verify credentials are correct
   - Check if the password is properly hashed

### Testing

Run the test scripts to verify the authentication system:

```bash
# Test connection
npm run test:connection

# Test login
npm run test:login
```